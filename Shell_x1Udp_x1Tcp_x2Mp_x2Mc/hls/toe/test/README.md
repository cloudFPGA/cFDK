# cloudFPGA / SHELL / hls / toe / test

**This directory is dedicated to the testbench of the TCP Offload Engine (TOE).**
 
## PRELIMINARY
The test of the TOE consists of a single testbench file called **_test_toe.[cpp,hpp]_**. This testbench contains a set of traffic generators and traffic sinks to respectively feed and drain the inputs and outputs of the TOE, as depicted in the following  figure. The user specifies the traffic scenario he wants to run via one or two test vector files (in green color).  These files are read by the testbench and used to feed the the iputs port of the TOE. The stimuli generated by the output ports of the TOE are collected by the testbench and are written into files (see white color). Beside that, the testbench also generates two golden reference files (see yellow color) containing the expected test vectors to be compared against the output stimuli produced by the TOE.

![Structure of the testbench](https://github.ibm.com/cloudFPGA/SRA/blob/fab_nts/FMKU60/SHELL/Shell_x1Udp_x1Tcp_x2Mp_x2Mc/hls/toe/test/images/Fig-TestToe-Structure.bmp)

## COMPONENTS
The major components of the testbench are:
- **DUT** - The Device Under Test (.i.e, the TCP Offload Engine). 
- **pIPRX** - A process to emulate the behavior of the IP Rx Path (IPRX).  
- **pL3MUX** - A process to emulate the behavior of the Layer-3 Multiplexer (L3MUX).
- **pTRIF** - A process to mulate the behavior of the TCP Role Interface (TRIF).
- **pTxMem** - A process to emulate the behavior of the Transmit DDR4 Buffer Memory (TXMEM).
- **pRxMem** - A process to emulate the behavior of the Receive DDR4 Buffer Memory (RXMEM).
- **pCAM** - A process to emulate the behavior of the Content Addressable Memory (CAM).

## HOW TO CONSTRUCT AN INPUT VECTOR FILE
Input vector files are store in the directory "**_./testVectors_**" and come with a **_.dat_** file extension. The filename of the files used to feed the **IPRX** process with IP frames are prefixed with the string "**_ipRx__**", while the files used to feed the **TRIF** process with TCP payload are prefixed with the string "**_appRx__**".

### Data Vector
The data vectors are stored and formatted according to the AXI4-Stream interface of the process that they feed. Here is an example of five vectors designed to drive an AXI4-Stream consisting of 64 data bits, 8 keep bits and 1 last bit:
- ``0000000028000045 0 FF``
- ``0A0A0A0A000006FF 0 FF``
- ``5700890001C80C0A 0 FF``
- ``00000000CDFF0000 0 FF``
- ``000013C500040250 1 FF``

Note that the first character of the line CANNOT NOT be a space character.

### Comment
A command or a comment start with a single
            //--       character followed by a space character.

## How To RUN A HLS C SIMULATION
- Option-1: The simplest way it to run all the tests at once. To do that, you start from the upper directory (*cd ..*) and you run the following command: **make csim**.
- Option-2: Run a single test from the Vivado HLS IDE. To do that, open the menu **Project->Project Settings->Simulations** and add the arguments to be used by the testbench called 'test_toe.cpp'.
    - As an exemple, the following two input arguments *'1 ../../../../test/testVectors/appRx_OneSeg.dat'* will run the testbench in TX_MODE (1) while using the test vector file 'appRx_OneSeg.dat'. Refer to '../run_hls.tcl' for more exemples.
