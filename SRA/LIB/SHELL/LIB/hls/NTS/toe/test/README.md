# cloudFPGA / SHELL / hls / toe / test
**Note:** [This HTML section is rendered based on the Markdown file in cFDK.](https://github.com/cloudFPGA/cFDK/blob/master/SRA/LIB/SHELL/LIB/hls/NTS/toe/test/README.md)


**This directory is dedicated to the testbench of the TCP Offload Engine (TOE).**
 
## PRELIMINARY
The test of the TOE consists of a single testbench file called **_test_toe.[cpp,hpp]_**. This testbench contains a set of traffic generators and traffic sinks to respectively feed and drain the inputs and outputs of the TOE, as depicted in the following  figure. The user specifies the traffic scenario he wants to run via one or two test vector files (in green color).  These files are read by the testbench and used to feed the the iputs port of the TOE. The stimuli generated by the output ports of the TOE are collected by the testbench and are written into files (see white color). Beside that, the testbench also generates two golden reference files (see yellow color) containing the expected test vectors to be compared against the output stimuli produced by the TOE.

![Structure of the testbench](https://github.com/cloudFPGA/cFDK/blob/master/SRA/LIB/SHELL/LIB/hls/NTS/toe/test/./images/Fig-TestToe-Structure.bmp?raw=true)


## COMPONENTS
The major components of the testbench are:
- **DUT** - The Device Under Test (.i.e, the TCP Offload Engine). 
- **pIPRX** - A process to emulate the behavior of the IP Rx Path (IPRX).  
- **pL3MUX** - A process to emulate the behavior of the Layer-3 Multiplexer (L3MUX).
- **pTRIF** - A process to mulate the behavior of the TCP Role Interface (TRIF).
- **pTxMem** - A process to emulate the behavior of the Transmit DDR4 Buffer Memory (TXMEM).
- **pRxMem** - A process to emulate the behavior of the Receive DDR4 Buffer Memory (RXMEM).
- **pCAM** - A process to emulate the behavior of the Content Addressable Memory (CAM).

## HOW TO CONSTRUCT INPUT VECTOR FILES
Input vector files are store in the directory "**_./testVectors_**" and come with a **_.dat_** file extension. The filename of the files used to feed the **IPRX** process with IP frames are prefixed with the string "**_ipRx__**", while the files used to feed the **TRIF** process with TCP payload are prefixed with the string "**_appRx__**".

Every line of the input vector file is either a **_Data Vector_**, a **_Gobal Parameter_**, a **_Command_** or a **_Comment_** line.

### Data Vector
Data vectors are stored and formatted according to the AXI4-Stream interface of the process that they feed. Here is an example of five vectors designed to drive an AXI4-Stream consisting of 64 data bits, 8 keep bits and 1 last bit:
```
0000000028000045 0 FF
0A0A0A0A000006FF 0 FF
5700890001C80C0A 0 FF
00000000CDFF0000 0 FF
000013C500040250 1 FF
```
Note: The first character of a data vector line CANNOT be a space character!

### Global Parameter
A global parameter can be set at the beginning of the test vector file to specify a general property of the testbench. The supported parameters include:
```
G PARAM SimCycles     <NUM>         --> Request a minimum of <NUM> simulation cycles.
G PARAM LocalSocket   <ADDR> <PORT> --> Request to setup a local socket for the TOE. 
G PARAM ForeignSocket <ADDR> <PORT> --> Request to setup a foreign socket.
```
Note: The line containing a global parameter must start with the character **'G'** (in upper-case) followed by a space character.

### Command
A command can be inlined between data vectors to change the dynamic behavior of the testbench. The supported commands include:
```
> SET   ForeignSocket <ADDR> <PORT> --> Request to add foreign socket.
> IDLE  <NUM>                       --> Request to idle for <NUM> cycles.
```
Note: The line containing a command must start with the character **'>'** followed by a space character.

### Comment
You add comment line into the test vector file by starting a line with the character **'#'** followed by a space character.
```
# This is a comment.
```


## OUTPUT VECTOR FILES
Output vector files are store in the current directory and come with the file extensions **_.dat_** or **_.strm_**.  The filename of the output vector files generated by the process **L3MUX** and which contain IP frames (.dat) or TCP paylaod (.strm), are prefixed with the string "**_ipTx__**". The output vector files generated by the process **TRIF** and which contain only TCP payload, are prefixed with the string "**_appTx__**".


## GOLDEN OUTPUT FILES
If possible, golden files are generated by the processes which feed the **TOE**. These files are used at the end of the simulation run for comparison against the generated output vector files. Golden files are stored in the current directory and come with the file extensions **_.gold_**. Golden files prefixed with the string "**_appTx__**" are compared with output vector files prefixed with the same string, and respectively for the golden files which are prefixed with the string "**_ipTx__**".


## How TO RUN A HLS C SIMULATION
### Option-1 
The simplest way it to run all the test vector files at once. To do that, you start from the upper directory and you build the project with the _csim_ option.
```
    cd ..
    make csim
```
### Option-2 
Run a single test from the Vivado HLS IDE. To do that, open the menu **Project->Project Settings->Simulations** and add the arguments to be used by the testbench called '_test_toe.cpp_'. As an exemple, the following two input arguments will run the testbench in _TX_MODE(1)_ while using the test vector file '_appRx_OneSeg.dat_'. 
```
    1 ../../../../test/testVectors/appRx_OneSeg.dat' 
```
Refer to the file '_../run_hls.tcl_' for more examples.

